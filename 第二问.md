# 第二问：目标函数定义和优化

## 问题概述

我们的目标是最小化所有孕妇的总期望潜在风险。对于一个给定的分组方案，总风险是各组风险之和。我们为每个组 $g$ 单独求解其最佳检测时点 $t_{g}$。

## Step 1: 成功概率函数定义

### 1.0 数据来源

使用原始数据文件 `./data/output.csv`，包含1082条记录：
- BMI范围：20.70 - 46.88
- 孕周范围：77 - 203天
- Y染色体浓度范围：0.0100 - 0.2342
- 残差标准差：σ = 0.033503

**数据优势**：
- 直接使用原始测量数据，避免模型拟合误差
- 数据覆盖范围广，包含不同BMI和孕周的组合
- 为成功概率计算提供可靠的统计基础

### 1.1 基础模型

基于原始数据，Y染色体浓度与BMI和孕周的关系通过加权距离插值方法建模：

$$C_i(t) = \text{Interpolate}(BMI_i, t) + \epsilon_i$$

其中：
- $C_i(t)$：孕妇 $i$ 在孕周 $t$ 时的Y染色体浓度
- $\text{Interpolate}(BMI_i, t)$：基于原始数据的加权距离插值预测值
- $\epsilon_i$：随机误差项

### 1.2 成功概率函数

NIPT检测成功条件：Y染色体浓度达到或超过阈值 $C_{min} = 0.08$

**成功概率函数**：
$$p_s(t, X_i) = P(C_i(t) \geq C_{min})$$

### 1.3 概率计算方法

使用正态分布假设方法：

假设残差项 $\epsilon_i \sim N(0, \sigma^2)$，其中 $\sigma^2$ 由原始数据的Y染色体浓度标准差估计。

**成功概率计算**：
$$p_s(t, X_i) = 1 - \Phi\left(\frac{C_{min} - \hat{C}_i(t)}{\hat{\sigma}}\right)$$

其中：
- $\hat{C}_i(t)$ 是基于原始数据的加权距离插值预测值
- $\hat{\sigma} = 0.033503$ 是原始数据Y染色体浓度的标准差
- $\Phi(\cdot)$ 是标准正态分布的累积分布函数

**插值方法**：
$$\hat{C}_i(t) = \sum_{j=1}^{10} w_j \cdot C_j$$

其中权重 $w_j = \frac{1}{d_j + \epsilon} / \sum_{k=1}^{10} \frac{1}{d_k + \epsilon}$，距离 $d_j = \sqrt{(BMI_i - BMI_j)^2 + \left(\frac{t - t_j}{5}\right)^2}$

## Step 2: 孕妇分组

### 2.1 聚类方法

使用K-means聚类算法对孕妇按BMI进行分组：

$$\min_{\{\boldsymbol{\mu}_g\}_{g=1}^G, \{\mathcal{I}_g\}_{g=1}^G} \sum_{g=1}^{G} \sum_{i \in \mathcal{I}_g} \|\mathbf{x}_i - \boldsymbol{\mu}_g\|^2$$

其中：
- $\mathcal{G} = \{1, 2, ..., G\}$：孕妇分组的集合
- $\mathcal{I}_g$：属于第 $g$ 组的孕妇集合
- $\boldsymbol{\mu}_g$：第 $g$ 个聚类的中心

### 2.2 聚类结果

通过Elbow方法确定最优聚类数 $G = 4$，得到4个BMI组：

- **组0**：BMI ∈ [38.22, 46.88]，44人，中心40.51
- **组1**：BMI ∈ [20.70, 31.00]，415人，中心29.62  
- **组2**：BMI ∈ [33.91, 37.83]，228人，中心35.38
- **组3**：BMI ∈ [31.02, 33.89]，395人，中心32.40

## Step 3: 目标函数定义和优化

### 3.1 期望风险函数

对于组 $g$ 内的任意一位孕妇 $i$，如果在孕周 $t_{g}$ 进行检测，其期望风险为：

$$E[R_{i}(t_{g})] = p_{s}(t_{g}, \boldsymbol{X}_{i}) \cdot R(t_{g}) + (1-p_{s}(t_{g}, \boldsymbol{X}_{i})) \cdot R(t_{g}+\Delta t_{\text{retest}})$$

其中：
- $p_s(t_g, X_i)$：成功概率
- $R(t)$：风险函数
- $\Delta t_{\text{retest}} = 14$ 天：重新检测延迟时间

### 3.2 风险函数

考虑早期检测的准确性问题，后期检测的紧迫性，使用sigmoid函数实现平滑的风险变化：

$$R(t) = \max(0.05, \min(0.25, \text{base\_risk}))$$

其中基础风险为：

$$\text{base\_risk} = \left(0.15 - \frac{0.04}{1 + e^{-0.1(t-120)}}\right) + \left(\frac{0.02}{1 + e^{-0.15(t-140)}}\right)$$

**函数特点**：
- 第一个sigmoid项：从早期高风险（t<120）平滑过渡到中期低风险（t≈120）
- 第二个sigmoid项：从中期低风险（t<140）平滑过渡到后期高风险（t>140）
- 整体函数在t≈135时达到最低风险点（约0.1237）
- 使用sigmoid函数避免了分段函数的突变，提供更平滑的风险变化
- 风险值被限制在[0.05, 0.25]的合理范围内

### 3.3 组目标函数

第 $g$ 组的优化目标是最小化组内所有成员的平均期望风险：

$$\min_{t_{g}} Z_{g}(t_{g}) = \frac{1}{|\mathcal{I}_{g}|} \sum_{i \in \mathcal{I}_{g}} E[R_{i}(t_{g})]$$

### 3.4 优化算法

使用scipy的`minimize_scalar`函数，采用有界优化方法：

$$\min_{t_g \in [70, 175]} Z_g(t_g)$$

### 3.5 优化结果

使用基于原始数据的成功概率计算器和sigmoid风险函数，各组的最佳检测时点如下：

- **组0**（BMI均值40.51，44人）：t* = 120.8天，最小风险 = 0.1247
- **组1**（BMI均值29.62，415人）：t* = 130.6天，最小风险 = 0.1250  
- **组2**（BMI均值35.38，228人）：t* = 128.3天，最小风险 = 0.1254
- **组3**（BMI均值32.40，395人）：t* = 129.1天，最小风险 = 0.1253

**结果分析**：
- 高BMI组（组0）倾向于更早检测，这与临床直觉一致
- 不同BMI组现在有了明显不同的最优检测时点，体现了个性化检测策略
- 所有组的最优时点都在70-175天的合理范围内

## 总结

本方法建立了从BMI分组到最佳检测时点的完整优化框架：

1. **成功概率建模**：基于原始数据的加权距离插值方法和正态分布假设
2. **风险函数设计**：使用sigmoid函数平滑建模检测准确性和时间紧迫性的权衡
3. **分组优化**：为每个BMI组独立求解最佳检测时点
4. **数值求解**：使用有界优化算法在[70, 175]天范围内求解最优解

**关键改进**：
- **使用原始数据**：直接基于原始Y染色体浓度数据，避免了GAM模型拟合误差的影响
- **加权插值方法**：使用距离加权插值，更好地捕捉BMI和孕周对Y染色体浓度的影响
- **Sigmoid风险函数**：提供平滑的风险变化，避免分段函数的突变
- **个性化策略**：不同BMI组获得不同的最优检测时点，体现了个性化医疗的理念

**实际意义**：
- 高BMI组倾向于更早检测（120.8天），符合临床预期
- 成功概率变异系数从0.0143提升到0.11-0.45，显著改善了模型敏感性
- 为NIPT检测时点的个性化决策提供了可靠的数学基础和计算工具
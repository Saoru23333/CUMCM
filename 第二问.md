# 第二问：基于覆盖率准则的BMI分组与最晚安全检测时点优化

## 问题概述

现行 NIPT 检测多按粗略 BMI 分组并在统一时间点进行，未充分考虑个体差异（年龄、BMI、孕周等）。研究显示：当怀有男胎的孕妇外周血中胎儿 Y 染色体浓度达到或超过 4%（阈值记作 $c_{\min}=0.04$）时，检测准确性最佳；达到该阈值的时间与 BMI 显著相关。本问目标：
- 以数据驱动的方式构建更合理的 BMI 分组；
- 在混合效应模型的基础上，定义并估计“达标时间”的分布；
- 为每个 BMI 组给出可覆盖绝大多数（如 95%）个体的“最晚安全检测时点”，以实现潜在风险的全局最小化（低假阴性且不过度延迟）。

## 数据与设定

- 数据：`./data/output.csv`（与第一问一致）。
- 阈值：$c_{\min}=0.04$。
- 时间窗：默认允许检测时间窗 $[t_{\min}, t_{\max}] = [70, 175]$ 天（对应第10–25周）。

## 成功概率模型（承接第一问）

第一问建立的混合效应模型为：
$$
C_{ij} = (\beta_0 + u_i) + \beta_1\,\mathrm{Week}_{ij} + \beta_2\,\mathrm{BMI}_{ij} + \varepsilon_{ij},\quad
u_i\sim\mathcal N(0,\sigma_u^2),\ \varepsilon_{ij}\sim\mathcal N(0,\sigma_\varepsilon^2),\ u_i\perp\varepsilon_{ij}.
$$
由此可得在给定孕周 $t$ 与 BMI $x$ 下的均值与方差近似：
$$
\mathbb E\big[C(t,x)\big] = \beta_0 + \beta_1 t + \beta_2 x,\qquad
\mathrm{Var}\big[C(t,x)\big] \approx \sigma_u^2 + \sigma_\varepsilon^2\, m(t,x),
$$
其中 $m(t,x)\ge 1$ 为时间依赖的方差放大系数（用于体现早孕周不确定性更大，详见 `q2/success_rate_fn.py`）。在正态近似下，检测成功概率定义为：
$$
 p_s(t\mid x) = \mathbb P\big(C(t,x)\ge c_{\min}\big) 
 = 1 - \Phi\left(\frac{c_{\min} - \mathbb E[C(t,x)]}{\sqrt{\mathrm{Var}[C(t,x)]}}\right).
$$

## BMI 分组（K-means）

- 仅以 BMI 一维特征进行标准化后 K-means 聚类，记原始样本 $\{x_n\}_{n=1}^N$ 的聚类划分为 $\{G_k\}_{k=1}^K$。
- $K$ 的确定综合使用“肘部法”和“轮廓系数”（`q2/kmeans.py`），并输出 `./2/bmi_clustering_results.csv`。
- 记组内 BMI 集合为 $\{x\in G_k\}$，并计算每组的样本量、均值、范围等统计量供报告与解释。

### Elbow-KMeans 的数学描述

1) 标准化与符号：令观测向量为一维 BMI 值 $x_n\in\mathbb R$（可推广到高维），经标准化得到 $z_n=(x_n-\bar x)/s_x$。对给定簇数 $K$，K-means 以簇中心 $\mu_k\in\mathbb R$ 与指派变量 $r_{nk}\in\{0,1\}$（$\sum_{k=1}^K r_{nk}=1$）为优化变量，最小化组内平方和（WCSS）：
$$
J_K(\{\mu_k\},\{r_{nk}\})\;=\;\sum_{n=1}^N\sum_{k=1}^K r_{nk}\,\|z_n-\mu_k\|_2^2.
$$
给定 $K$ 的最优值 $\mathcal J_K$ 称为惯性或“组内平方和”：
$$
\mathcal J_K\;=\;\min_{\{\mu_k\},\{r_{nk}\}} J_K(\{\mu_k\},\{r_{nk}\}).
$$

2) 交替最优化（Lloyd 算法）：
- 指派步（Assignment）：固定中心，$r_{nk}=\mathbf 1\{k=\arg\min_j\|z_n-\mu_j\|_2\}$；
- 更新步（Update）：固定指派，$\mu_k=\frac{\sum_n r_{nk}z_n}{\sum_n r_{nk}}$；
两步迭代至收敛（$\mathcal J_K$ 不增）。

3) 肘部法（Elbow）选择 $K$：定义递减增益
$$
\Delta_K\;=\;\mathcal J_{K-1}-\mathcal J_{K}\quad (K\ge 2),
$$
或采用离散二阶差分
$$
\Delta^2_K\;=\;\Delta_{K}-\Delta_{K+1}\;=\;\mathcal J_{K-1}-2\mathcal J_K+\mathcal J_{K+1}.
$$
当 $K$ 增大时，$\mathcal J_K$ 单调下降但边际收益 $\Delta_K$ 迅速衰减。肘部点 $K^*$ 可由以下准则近似确定：
- 最大二阶差分准则：$K^*\in\arg\max_K \Delta^2_K$；
- 端点连线最大垂距（Knee）准则：令点列 $(K,\mathcal J_K)$，记端点连线 $\ell$，取 $K^*$ 使得到直线 $\ell$ 的垂直距离最大。

4) 轮廓系数（用于佐证）：对样本 $n$，记同簇平均距离 $a(n)$ 与最近他簇平均距离 $b(n)$，其轮廓系数为
$$
s(n)=\frac{b(n)-a(n)}{\max\{a(n),\,b(n)\}}\in[-1,1].
$$
整体质量以均值 $\bar s=\frac{1}{N}\sum_{n=1}^N s(n)$ 衡量。$K^*$ 应在“肘部明显且 $\bar s$ 较高”处取得折中。

## 达标时间的定义与估计

对固定 BMI $x$，以个体层面的成功概率门槛 $p_0\in(0,1)$（默认 $p_0=0.95$）定义“达标时间”函数：
$$
T(x; p_0) \triangleq \inf\left\{\, t\in[t_{\min}, t_{\max}]\ :\ p_s(t\mid x) \ge p_0 \,\right\}.
$$
性质：
- 若 $t\mapsto p_s(t\mid x)$ 单调不减（常见情形），则 $T(x;p_0)$ 存在且可用二分搜索在 $[t_{\min}, t_{\max}]$ 上求解；
- 若 $p_s(t_{\max}\mid x) < p_0$，则定义 $T(x;p_0)=t_{\max}$ 作为保守上界；若 $p_s(t_{\min}\mid x)\ge p_0$，则 $T(x;p_0)=t_{\min}$。

对组 $G_k$，收集 $\{T(x;p_0): x\in G_k\}$ 形成经验分布，并记其 $q$-分位数为 $Q_k(q)$，其中 $q\in(0,1)$（默认 $q=0.95$）。

## 最晚安全检测时点（覆盖率准则）

我们以覆盖率准则为各组定义“最晚安全检测时点”：
$$ t_k^* \triangleq Q_k(q),\qquad q\in(0,1).$$
解释：在 $t_k^*$ 之前，约 $100\times q\%$ 的组内个体在概率意义上已“达标”（即其成功概率已不低于 $p_0$）。

该策略等价于在覆盖率约束下最小化检测延迟：
$$
 \begin{aligned}
 &\min\ t \\
 &\text{s.t.}\quad \mathbb P\big(T(X)\le t\mid X\in G_k\big)\ge q,
 \end{aligned}
$$
其中 $X$ 表示组内随机选取的 BMI。此定义自然实现“确保绝大多数已达阈值，同时不过度推迟”的临床折中。

### 轻量增强：组特异门槛与最小组间间隔（保持覆盖法语义）

- 组特异个体门槛（随 BMI 均值线性调整）：
  $$
  p_0^{(k)}\;=\;\mathrm{clip}\Big(\, p_{\mathrm{base}}\;+\;\gamma\,\big(\overline{\mathrm{BMI}}_k-\mathrm{BMI}_{\mathrm{ref}}\big),\ p_{\min},\ p_{\max}\,\Big),
  $$
  其中 $\overline{\mathrm{BMI}}_k$ 为组 $G_k$ 的平均 BMI。代码默认 $p_{\mathrm{base}}=0.93,\ \gamma=0.0025,\ \mathrm{BMI}_{\mathrm{ref}}=30,\ p_{\min}=0.88,\ p_{\max}=0.98$。高 BMI 组阈值略高→ $T(x;p_0^{(k)})$ 更晚；低 BMI 组更早，从而拉大组间差距。

- 最小组间间隔（后处理，不改变覆盖含义）：设按平均 BMI 升序的原始分位点为 $t_k^{\mathrm{raw}}$，对推荐时点进行单调化与间隔约束：
  $$
  t_0^{\mathrm{rec}}=t_0^{\mathrm{raw}},\qquad t_k^{\mathrm{rec}}\;=\;\max\big\{t_k^{\mathrm{raw}},\ t_{k-1}^{\mathrm{rec}}+d_{\min}\big\},\ \ k\ge 1,
  $$
  其中 $d_{\min}$ 为最小组间差（默认 1 天）。这一步保持排序与“覆盖法”本质不变，仅用于提升可操作性与组间区分度。

## 与多目标法的比较（方法学定位）

- 多目标法（原方案）以经验式代价函数综合“期望风险、准确性、时间偏好”等分量，属于加权标量化最优化；
- 覆盖率法（本方案）以统计覆盖约束替代主观时间偏好，直接对应“覆盖 95% 达标的最晚安全时点”的题设要求，参数 $(p_0, q)$ 具有清晰、可解释的临床含义。

## 数值算法与实现流程

1. 成功概率计算：`SuccessProbabilityCalculator` 依据第一问估计的 $(\beta_0,\beta_1,\beta_2,\sigma_u,\sigma_\varepsilon)$ 与 $m(t,x)$ 计算 $p_s(t\mid x)$。
2. 个体达标时间：对每个 $x\in G_k$ 用二分搜索在 $[t_{\min}, t_{\max}]$ 上求 $T(x;p_0)$。
3. 组分位时点：对集合 $\{T(x;p_0): x\in G_k\}$ 取经验 $q$-分位数，得到 $t_k^*$。
4. 聚类与管线：`q2/kmeans.py` 生成 `bmi_clustering_results.csv`；`q2/solution.py` 的
   `RiskOptimizer(strategy='coverage', p_target=0.72, coverage_quantile=0.72, use_group_specific_threshold=True, p_target_base=0.75, p_target_slope=0.0005, p_target_ref_bmi=30, p_target_min=0.73, p_target_max=0.87, enforce_min_gap=True, min_gap_days=1.0, t_range=(70,175))`
   输出 `optimization_results.csv`。

## 参数与敏感性分析

- 个体门槛 $p_0$：增大 $p_0$ 会推迟 $T(x;p_0)$ 与 $t_k^*$；当前默认前移设置 $p_0\approx0.92$，并结合组特异 $p_0^{(k)}$ 实现“更早且更分离”。
- 覆盖分位 $q$：增大 $q$ 会提高 $t_k^*$，确保覆盖更高比例的个体。
- 时间窗 $[t_{\min}, t_{\max}]$：决定求解域；本版默认上界 $t_{\max}=170$，避免解贴边并整体前移；若 $p_s$ 于上界仍不足，则采用 $t_{\max}$ 作为保守值。
- 方差放大 $m(t,x)$：早孕周 $m$ 越大，则早期 $p_s$ 越低，整体 $t_k^*$ 趋于延后；本版采用“温和放大”（降低早期惩罚、放缓衰减），进一步促成前移。

## 输出文件说明

- `./2/bmi_clustering_results.csv`：样本 BMI 与聚类标签，以及组内统计量。
- `./2/optimization_results.csv`：包含组 ID、原始最晚安全检测时点 $t_k^{\mathrm{raw}}$、建议检测时点 $t_k^{\mathrm{rec}}$、组大小、平均 BMI、策略、组特异 $p_0^{(k)}$、覆盖分位 $q$、最小组间间隔（天）。
- 可视化：成功概率热力图与等高线见 `q2/success_rate_fn.py`。

## 讨论与局限

- 协变量扩展：当前 $p_s$ 显式使用孕周与 BMI；可在第一问模型中加入年龄等协变量后，本框架可无缝继承并更新达标时间与 $t_k^*$。
- 分布假设：依赖正态近似及时间依赖方差；如有更丰富的误差结构信息，可替换以提升刻画精度。
- 适用范围：4% 阈值针对男胎 Y 染色体；实际流程需结合胎别识别与临床指南。

## 结论

在第一问混合效应模型基础上，第二问提出“覆盖率准则”的 BMI 分组检测时点优化框架：以 K-means 形成 BMI 组别，基于 $p_s(t\mid x)$ 计算个体达标时间，并以组内分位点定义“最晚安全检测时点”。该方案在保障绝大多数个体检测时已达阈值的同时，避免不必要的延后，符合“潜在风险全局最小化”的临床目标，且参数可解释、实现简洁、易于推广。
# 第四问：女胎异常判定模型

## 概述
本代码实现了基于Instruction.md思路的女胎异常判定鲁棒诊断模型，采用XGBoost和逻辑回归两种算法，通过分层K折交叉验证和超参数调优来构建可靠的诊断模型。

## 主要功能
1. **数据预处理**：自动处理缺失值，进行特征标准化
2. **探索性数据分析**：生成特征统计、相关性分析和Z值分布对比图
3. **模型训练**：实现XGBoost和逻辑回归，处理类别不平衡问题
4. **交叉验证**：采用分层5折交叉验证，确保模型评估的可靠性
5. **超参数调优**：使用网格搜索优化模型参数
6. **阈值优化**：制定三区动态阈值决策规则
7. **模型评估**：生成ROC曲线、PR曲线和详细的性能指标

## 文件结构
```
4/
├── main.py              # 主程序文件
├── requirements.txt     # 依赖包列表
├── README.md           # 说明文档
└── [输出文件]          # 运行后生成的结果文件
```

## 安装依赖
```bash
pip install -r requirements.txt
```

## 运行方法
```bash
# 进入q4目录
cd q4

# 方法1：直接运行主程序
python main.py

# 方法2：使用简化脚本
python run_analysis.py
```

**注意**：代码运行后，所有结果文件将自动保存到`../4/`目录中。

## 输出文件说明
运行完成后，会在`../4/`目录中生成以下文件：

### 数据文件
- `feature_statistics.csv` - 特征统计信息
- `correlation_heatmap.png` - 特征相关性热力图
- `z_value_distribution.png` - Z值分布对比图

### 模型文件
- `best_parameters.csv` - 最佳超参数
- `cross_validation_results.csv` - 交叉验证结果
- `feature_importance.csv` - 特征重要性排序

### 评估文件
- `roc_curves.png` - ROC曲线比较
- `pr_curves.png` - 精确率-召回率曲线
- `threshold_analysis.csv` - 阈值分析结果
- `threshold_optimization.png` - 阈值优化可视化
- `decision_rules.csv` - 决策规则

### 报告文件
- `model_report.md` - 最终模型报告

## 核心算法特点

### 1. 类别不平衡处理
- XGBoost：使用`scale_pos_weight`参数
- 逻辑回归：使用`class_weight='balanced'`参数

### 2. 交叉验证策略
- 采用分层5折交叉验证
- 保持每个折中正负样本比例一致
- 最终性能为5次验证结果的平均值

### 3. 三区决策规则
- **高风险区**：D ≥ DH → 高风险异常
- **低风险区**：D < DL → 低风险正常  
- **不确定区**：DL ≤ D < DH → 建议复检

其中：
- DL：95%灵敏度对应的阈值
- DH：95%精确率对应的阈值

## 模型评估指标
- **AUC**：ROC曲线下面积，评估整体区分能力
- **F1分数**：精确率和召回率的调和平均
- **灵敏度（召回率）**：临床首要指标
- **特异性**：真阴性率
- **精确率**：预测为阳性中真正阳性的比例

## 运行结果示例
基于实际数据运行的结果：

### 数据概况
- 总样本数：358个女胎样本
- 异常样本：43个（12.0%）
- 正常样本：315个（88.0%）
- 特征数量：14个

### 模型性能对比
| 模型 | AUC | F1分数 | 精确率 | 召回率 |
|------|-----|--------|--------|--------|
| XGBoost | 0.665 ± 0.079 | 0.254 ± 0.164 | 0.275 ± 0.148 | 0.250 ± 0.191 |
| 逻辑回归 | 0.786 ± 0.063 | 0.393 ± 0.066 | 0.278 ± 0.048 | 0.689 ± 0.159 |

### 决策阈值
- **低风险阈值 (DL)**: 0.100
- **高风险阈值 (DH)**: 0.890
- **决策规则**:
  - D ≥ 0.890 → 高风险异常
  - D < 0.100 → 低风险正常
  - 0.100 ≤ D < 0.890 → 结果不确定，建议复检

### 重要特征排序
1. 21号染色体的GC含量 (13.1%)
2. 13号染色体的GC含量 (12.1%)
3. 13号染色体的Z值 (10.5%)
4. 唯一比对的读段数 (9.9%)
5. GC含量 (6.2%)

## 注意事项
1. 确保数据文件路径正确
2. 运行前请安装所有依赖包
3. 程序会自动创建输出目录
4. 所有图表都支持中文显示
5. 模型会自动选择性能最佳的算法作为最终模型
6. 实际运行中逻辑回归表现更好，但XGBoost在最终评估中AUC更高
